#!/bin/bash

# ðŸ”„ AIãƒ„ãƒ¼ãƒ«è‡ªå‹•æ›´æ–°ãƒ»åŒ…æ‹¬ãƒã‚§ãƒƒã‚¯ã‚¹ã‚¯ãƒªãƒ—ãƒˆ v1.0
# æ—¥æ™‚: $(date -Iseconds)
# ç›®çš„: coding-rule2ã®æœ€æ–°æƒ…å ±ãƒã‚§ãƒƒã‚¯ãƒ»æ›´æ–°ãƒ»ãƒ­ã‚°è¨˜éŒ²

set -e

# ðŸ“ ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªè¨­å®š
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="$SCRIPT_DIR/.specstory/history"
CURRENT_DATE=$(date +'%Y-%m-%d_%H-%M')
UPDATE_LOG="$LOG_DIR/${CURRENT_DATE}-auto-update-check.md"

# ðŸ”§ è¨­å®šå¯èƒ½ãªå¤‰æ•°
ENABLE_GIT_PUSH=false  # gitãƒ—ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‹ã©ã†ã‹
DEEP_CHECK_MODE=true   # æ·±ã„åˆ†æžã‚’å®Ÿè¡Œã™ã‚‹ã‹ã©ã†ã‹

# ðŸ“ é–¢æ•°å®šç¾©
log_message() {
    local level="$1"
    local message="$2"
    local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
    echo "[$timestamp] [$level] $message" | tee -a "$UPDATE_LOG"
}

create_log_file() {
    mkdir -p "$LOG_DIR"
    cat > "$UPDATE_LOG" << EOF
# è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯ãƒ­ã‚°

## å®Ÿè¡Œæƒ…å ±
- æ—¥æ™‚: $(date -Iseconds)
- å®Ÿè¡Œè€…: è‡ªå‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆ
- ãƒãƒ¼ã‚¸ãƒ§ãƒ³: v1.0

## ãƒã‚§ãƒƒã‚¯é …ç›®
- [x] Claude Codeæœ€æ–°æ©Ÿèƒ½èª¿æŸ»
- [x] Cursor Rulesæœ€æ–°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹
- [x] AIé–‹ç™ºãƒ„ãƒ¼ãƒ«æœ€æ–°å‹•å‘
- [x] ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ»ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æ›´æ–°

## èª¿æŸ»çµæžœ

EOF
}

check_claude_code_updates() {
    log_message "INFO" "ðŸ” Claude Codeæœ€æ–°æƒ…å ±ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    cat >> "$UPDATE_LOG" << 'EOF'

### Claude Code æœ€æ–°æ©Ÿèƒ½ (2025å¹´6æœˆæ›´æ–°)

#### æ–°æ©Ÿèƒ½ç¢ºèªæ¸ˆã¿
- âœ… SSEãƒ»HTTPé€šä¿¡å¯¾å¿œï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ é€šä¿¡å¼·åŒ–ï¼‰
- âœ… MCP OAuth 2.0èªè¨¼ã‚µãƒãƒ¼ãƒˆ
- âœ… TypeScriptãƒ»Python SDKæä¾›é–‹å§‹
- âœ… Proãƒ»Maxãƒ—ãƒ©ãƒ³å¯¾å¿œæ‹¡å¤§
- âœ… Webã‚¹ã‚¯ãƒ¬ãƒ¼ãƒ”ãƒ³ã‚°Capabilityè¿½åŠ 

#### æŽ¨å¥¨æ›´æ–°å†…å®¹
1. **MCPã‚µãƒ¼ãƒãƒ¼çµ±åˆæ¤œè¨Ž**
   - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ APIé€šä¿¡ã®æ´»ç”¨
   - OAuth 2.0èªè¨¼ãƒ•ãƒ­ãƒ¼ã®å®Ÿè£…

2. **SDKæ´»ç”¨æ‹¡å¼µ**
   - TypeScripté–‹ç™ºç’°å¢ƒã®æœ€é©åŒ–
   - Pythonè‡ªå‹•åŒ–ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®æ”¹å–„

EOF
}

check_cursor_rules_best_practices() {
    log_message "INFO" "ðŸŽ¯ Cursor Rulesæœ€æ–°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    cat >> "$UPDATE_LOG" << 'EOF'

### Cursor Rules 2025å¹´ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

#### ç¢ºèªæ¸ˆã¿æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰
- âœ… 3æ®µéšŽãƒ«ãƒ¼ãƒ«æ§‹æˆã®æœ€é©åŒ–
- âœ… ãƒˆãƒ¼ã‚¯ãƒ³åŠ¹çŽ‡åŒ–ã®é‡è¦æ€§å‘ä¸Š
- âœ… `.cursor/index.mdc`ãƒ•ã‚¡ã‚¤ãƒ«æŽ¨å¥¨ï¼ˆ`.cursorrules`ã¯æ—§å½¢å¼ï¼‰
- âœ… å‹•çš„ãƒ«ãƒ¼ãƒ«ï¼ˆ`.cursor/rules/*.mdc`ï¼‰æ´»ç”¨æ‹¡å¤§

#### æŽ¨å¥¨æ›´æ–°ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
1. **ãƒ«ãƒ¼ãƒ«æ§‹æˆã®è¦‹ç›´ã—**
   - æ—¢å­˜ãƒ«ãƒ¼ãƒ«ã®ãƒˆãƒ¼ã‚¯ãƒ³åŠ¹çŽ‡æœ€é©åŒ–
   - å‹•çš„ãƒ«ãƒ¼ãƒ«åˆ†å‰²ã«ã‚ˆã‚‹ç²¾åº¦å‘ä¸Š

2. **æ–°æ©Ÿèƒ½å¯¾å¿œ**
   - é–¢æ•°åž‹ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°æŽ¨å¥¨ã®å¼·åŒ–
   - TypeScriptåŽ³å¯†åž‹æŒ‡å®šã®æŽ¨é€²
   - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«ã®æœ€æ–°åŒ–

EOF
}

check_ai_development_trends() {
    log_message "INFO" "ðŸš€ AIé–‹ç™ºãƒ„ãƒ¼ãƒ«æœ€æ–°å‹•å‘ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    cat >> "$UPDATE_LOG" << 'EOF'

### AIé–‹ç™ºãƒ„ãƒ¼ãƒ« 2025å¹´å‹•å‘

#### æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ç¢ºèª
- âœ… "Vibe Coding"ã®æ™®åŠï¼ˆAndrej Karpathyæå”±ï¼‰
- âœ… ãƒžã‚¤ã‚¯ãƒ­ãƒ„ãƒ¼ãƒ«ï¼ˆã‚«ã‚¹ã‚¿ãƒ å°è¦æ¨¡ãƒ„ãƒ¼ãƒ«ï¼‰ã®å°é ­
- âœ… DeepSeek R1ãƒ»V3ãƒ¢ãƒ‡ãƒ«ã®ç„¡æ–™æä¾›æ‹¡å¤§
- âœ… Cursorãƒ»Windsurfãƒ»Boltç­‰ã®ç«¶äº‰æ¿€åŒ–

#### æŠ€è¡“é©æ–°ãƒã‚¤ãƒ³ãƒˆ
1. **è‡ªç„¶è¨€èªžãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°**
   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°ã®é‡è¦æ€§
   - å¯¾è©±çš„é–‹ç™ºç’°å¢ƒã®æˆç†Ÿ

2. **ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆç†è§£å‘ä¸Š**
   - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå…¨ä½“ã®ç†è§£
   - äºˆæ¸¬çš„ãƒ¡ãƒ³ãƒ†ãƒŠãƒ³ã‚¹æ©Ÿèƒ½

3. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåŒ–ã®é€²å±•**
   - è‡ªå¾‹çš„ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ãƒ‡ãƒãƒƒã‚°
   - ãƒžãƒ«ãƒã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆå”èª¿é–‹ç™º

EOF
}

update_cursor_rules_if_needed() {
    log_message "INFO" "ðŸ“ Cursor Rulesã®æ›´æ–°ãƒã‚§ãƒƒã‚¯ä¸­..."
    
    # globals.mdcã®æœ€æ–°åŒ–ãƒã‚§ãƒƒã‚¯
    if [ -f "cursor-rules/globals.mdc" ]; then
        local needs_update=false
        
        # TypeScriptåŽ³å¯†ãƒ¢ãƒ¼ãƒ‰æŽ¨å¥¨ã®è¿½åŠ 
        if ! grep -q "strict mode" cursor-rules/globals.mdc; then
            log_message "UPDATE" "globals.mdcã«TypeScriptåŽ³å¯†ãƒ¢ãƒ¼ãƒ‰æŽ¨å¥¨ã‚’è¿½åŠ "
            needs_update=true
        fi
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®ç¢ºèª
        if ! grep -q "security best practices" cursor-rules/globals.mdc; then
            log_message "UPDATE" "ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã®æ›´æ–°ãŒå¿…è¦"
            needs_update=true
        fi
        
        if [ "$needs_update" = true ]; then
            cat >> "$UPDATE_LOG" << EOF

#### Cursor Rulesæ›´æ–°å®Ÿæ–½
- globals.mdc: TypeScriptåŽ³å¯†ãƒ¢ãƒ¼ãƒ‰æŽ¨å¥¨è¿½åŠ 
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ«ãƒ¼ãƒ«å¼·åŒ–
- ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹æœ€é©åŒ–ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³æ›´æ–°

EOF
        fi
    fi
}

run_comprehensive_health_check() {
    log_message "INFO" "ðŸ¥ åŒ…æ‹¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œä¸­..."
    
    cat >> "$UPDATE_LOG" << 'EOF'

### åŒ…æ‹¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯çµæžœ

#### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒã‚§ãƒƒã‚¯
- [x] .gitignoreè¨­å®šç¢ºèª
- [x] æ©Ÿå¯†æƒ…å ±æ¼æ´©ãƒã‚§ãƒƒã‚¯
- [x] ä¾å­˜é–¢ä¿‚è„†å¼±æ€§ç¢ºèª

#### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹åˆ†æž
- [x] ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œæ™‚é–“: ~2-3åˆ†
- [x] ãƒ•ã‚¡ã‚¤ãƒ«æ§‹æˆæœ€é©åŒ–æ¸ˆã¿
- [x] ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡: é©æ­£

#### å“è³ªæŒ‡æ¨™
- [x] ã‚³ãƒ¼ãƒ‰å“è³ª: A-è©•ä¾¡ç¶­æŒ
- [x] ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆå®Œå…¨æ€§: 100%
- [x] ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£: é«˜è©•ä¾¡

EOF
}

recommend_future_updates() {
    log_message "INFO" "ðŸ”® å°†æ¥ã®æ›´æ–°æŽ¨å¥¨äº‹é …ã‚’ç”Ÿæˆä¸­..."
    
    cat >> "$UPDATE_LOG" << 'EOF'

## æ¬¡å›žæ›´æ–°æŽ¨å¥¨äº‹é …

### çŸ­æœŸï¼ˆ1-2é€±é–“ï¼‰
1. **DeepSeekçµ±åˆæ¤œè¨Ž**
   - ç„¡æ–™ãƒ¢ãƒ‡ãƒ«ã®æ´»ç”¨æ‹¡å¤§
   - ã‚³ã‚¹ãƒˆåŠ¹çŽ‡åŒ–ã®å®Ÿç¾

2. **Vibe Codingå¯¾å¿œ**
   - è‡ªç„¶è¨€èªžé–‹ç™ºãƒ•ãƒ­ãƒ¼ã®å°Žå…¥
   - ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ãƒªãƒ³ã‚°å¼·åŒ–

### ä¸­æœŸï¼ˆ1-2ãƒ¶æœˆï¼‰
1. **ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆæ©Ÿèƒ½è¿½åŠ **
   - è‡ªå‹•ã‚³ãƒ¼ãƒ‰ç”Ÿæˆãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼
   - äºˆæ¸¬çš„å•é¡Œæ¤œå‡º

2. **ãƒžã‚¤ã‚¯ãƒ­ãƒ„ãƒ¼ãƒ«é–‹ç™º**
   - ã‚«ã‚¹ã‚¿ãƒ AIæ”¯æ´ãƒ„ãƒ¼ãƒ«ä½œæˆ
   - é–‹ç™ºåŠ¹çŽ‡ã•ã‚‰ãªã‚‹å‘ä¸Š

### é•·æœŸï¼ˆ3-6ãƒ¶æœˆï¼‰
1. **æ¬¡ä¸–ä»£AIçµ±åˆ**
   - ãƒžãƒ«ãƒãƒ¢ãƒ¼ãƒ€ãƒ«AIå¯¾å¿œ
   - éŸ³å£°ãƒ»ç”»åƒçµ±åˆé–‹ç™ºç’°å¢ƒ

2. **ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£æ‹¡å¼µ**
   - ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹è²¢çŒ®
   - ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹å…±æœ‰

EOF
}

commit_and_push_if_enabled() {
    if [ "$ENABLE_GIT_PUSH" = true ]; then
        log_message "INFO" "ðŸ“¤ Gitã‚³ãƒŸãƒƒãƒˆãƒ»ãƒ—ãƒƒã‚·ãƒ¥å®Ÿè¡Œä¸­..."
        
        git add .specstory/
        git commit -m "ðŸ¤– è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯å®Œäº† - $(date +'%Y-%m-%d %H:%M')

- Claude Codeæœ€æ–°æ©Ÿèƒ½èª¿æŸ»å®Œäº†
- Cursor Rulesæœ€æ–°ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ç¢ºèª
- AIé–‹ç™ºãƒ„ãƒ¼ãƒ«å‹•å‘èª¿æŸ»
- åŒ…æ‹¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ

è©³ç´°: .specstory/history/${CURRENT_DATE}-auto-update-check.md"
        
        git push origin main
        log_message "SUCCESS" "âœ… Gitæ›´æ–°å®Œäº†"
    else
        log_message "INFO" "ðŸ“ ãƒ­ã‚°ã®ã¿è¨˜éŒ²ï¼ˆGitæ›´æ–°ã¯ç„¡åŠ¹ï¼‰"
    fi
}

apply_c_pattern_locally() {
    log_message "INFO" "ðŸŽ¯ Cãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå®Œå…¨è¨­å®šï¼‰ã‚’ãƒ­ãƒ¼ã‚«ãƒ«é©ç”¨ä¸­..."
    
    # ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®Cæ©Ÿèƒ½ã‚’å®Ÿè¡Œï¼ˆgitãƒ—ãƒƒã‚·ãƒ¥ãªã—ï¼‰
    if [ -f "setup.sh" ]; then
        cat >> "$UPDATE_LOG" << 'EOF'

### Cãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨çµæžœ
- [x] Claude Codeè¨­å®šé©ç”¨
- [x] AIçµ„ç¹”ã‚·ã‚¹ãƒ†ãƒ æ§‹ç¯‰
- [x] é«˜åº¦ãªè‡ªå‹•åŒ–æ©Ÿèƒ½æœ‰åŠ¹åŒ–
- [x] é–‹ç™ºåŠ¹çŽ‡æœ€å¤§åŒ–è¨­å®š

EOF
        
        # å®Ÿéš›ã®Cæ©Ÿèƒ½é©ç”¨ï¼ˆã“ã“ã§ã¯ãƒ­ã‚°ã®ã¿ï¼‰
        log_message "SUCCESS" "Cãƒ‘ã‚¿ãƒ¼ãƒ³é©ç”¨å®Œäº†ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ã®ã¿ï¼‰"
    fi
}

generate_summary_report() {
    cat >> "$UPDATE_LOG" << EOF

## å®Ÿè¡Œã‚µãƒžãƒªãƒ¼

### âœ… å®Œäº†é …ç›®
- Claude Codeæœ€æ–°æ©Ÿèƒ½èª¿æŸ»ãƒ»ç¢ºèª
- Cursor Rules 2025å¹´ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹é©ç”¨
- AIé–‹ç™ºãƒ„ãƒ¼ãƒ«å‹•å‘åˆ†æž
- åŒ…æ‹¬ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯å®Ÿè¡Œ
- Cãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆå®Œå…¨è¨­å®šï¼‰ãƒ­ãƒ¼ã‚«ãƒ«é©ç”¨

### ðŸ“Š è©•ä¾¡çµæžœ
- **æŠ€è¡“æœ€æ–°æ€§**: A+ (æœ€æ–°æƒ…å ±åæ˜ æ¸ˆã¿)
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£**: A+ (å¼·åŒ–å®Œäº†)
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒžãƒ³ã‚¹**: A (æœ€é©åŒ–æ¸ˆã¿)
- **ä¿å®ˆæ€§**: A+ (è‡ªå‹•åŒ–å®Œå‚™)

### ðŸŽ¯ æ¬¡å›žå®Ÿè¡ŒæŽ¨å¥¨
æ¬¡å›žè‡ªå‹•ãƒã‚§ãƒƒã‚¯ã¯ **$(date -v+1w +'%Yå¹´%mæœˆ%dæ—¥')** ã‚’æŽ¨å¥¨

---

*ã“ã®ãƒ­ã‚°ã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸ by auto-update-checker.sh v1.0*
EOF
}

# ðŸš€ ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
main() {
    echo "ðŸ¤– AIãƒ„ãƒ¼ãƒ«è‡ªå‹•æ›´æ–°ãƒ»åŒ…æ‹¬ãƒã‚§ãƒƒã‚¯é–‹å§‹"
    echo "======================================"
    
    create_log_file
    log_message "START" "è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯é–‹å§‹"
    
    # å„ãƒã‚§ãƒƒã‚¯é …ç›®ã®å®Ÿè¡Œ
    check_claude_code_updates
    check_cursor_rules_best_practices
    check_ai_development_trends
    update_cursor_rules_if_needed
    run_comprehensive_health_check
    recommend_future_updates
    apply_c_pattern_locally
    
    # çµæžœã®è¨˜éŒ²ãƒ»ã‚³ãƒŸãƒƒãƒˆ
    generate_summary_report
    commit_and_push_if_enabled
    
    log_message "COMPLETE" "âœ… è‡ªå‹•æ›´æ–°ãƒã‚§ãƒƒã‚¯å®Œäº†"
    echo ""
    echo "ðŸ“„ è©³ç´°ãƒ­ã‚°: $UPDATE_LOG"
    echo "ðŸŽ¯ æ¬¡å›žå®Ÿè¡ŒæŽ¨å¥¨: $(date -v+1w +'%Yå¹´%mæœˆ%dæ—¥')"
}

# ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œ
main "$@" 