#!/usr/bin/env python3
"""
è‡ªå‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã‚·ã‚¹ãƒ†ãƒ 
ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã«å¸¸ã«æœ€æ–°ã®ã‚¿ã‚¹ã‚¯çŠ¶æ³ã‚’è¡¨ç¤º
"""

import json
from datetime import datetime
from pathlib import Path
from typing import Dict, List

class AutoStatusDisplay:
    """è‡ªå‹•ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º"""
    
    def __init__(self, project_root: str = "."):
        self.project_root = Path(project_root)
        self.status_file = self.project_root / "STATUS.md"
        self.progress_file = self.project_root / "PROGRESS.md"
    
    def generate_status_md(self) -> str:
        """STATUS.mdç”Ÿæˆ"""
        # å„ã‚·ã‚¹ãƒ†ãƒ ã‹ã‚‰çŠ¶æ³åŽé›†
        commitments = self._get_commitments()
        kanban = self._get_kanban_status()
        todos = self._get_claude_todos()
        
        status_md = f"""# ðŸ“‹ Current Project Status

**Last Updated**: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

## ðŸŽ¯ Active Tasks

### GitHub Commitments
{self._format_commitments(commitments)}

### Kanban Board
{self._format_kanban(kanban)}

### Claude Code Todos
{self._format_todos(todos)}

## ðŸ“Š Quick Stats
- **Active Commitments**: {len(commitments.get('active', []))}
- **In Progress**: {kanban.get('in_progress_count', 0)}
- **Pending Todos**: {len([t for t in todos if t.get('status') == 'pending'])}

## ðŸš¨ Alerts
{self._check_alerts(commitments, kanban)}

---
*Auto-generated by the integrity recovery system*
*Check with: `python3 scripts/kanban-board.py show`*
"""
        return status_md
    
    def _get_commitments(self) -> Dict:
        """ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆå–å¾—"""
        commitments_file = self.project_root / "runtime" / "commitments.json"
        if commitments_file.exists():
            with open(commitments_file, 'r') as f:
                data = json.load(f)
                active = [c for c in data.get('commitments', []) if c.get('status') != 'completed']
                return {'active': active, 'total': len(data.get('commitments', []))}
        return {'active': [], 'total': 0}
    
    def _get_kanban_status(self) -> Dict:
        """Kanbanã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾—"""
        kanban_file = self.project_root / "runtime" / "kanban-board.json"
        if kanban_file.exists():
            with open(kanban_file, 'r') as f:
                data = json.load(f)
                columns = data.get('columns', {})
                return {
                    'todo_count': len(columns.get('todo', [])),
                    'in_progress_count': len(columns.get('in_progress', [])),
                    'review_count': len(columns.get('review', [])),
                    'done_count': len(columns.get('done', []))
                }
        return {'todo_count': 0, 'in_progress_count': 0, 'review_count': 0, 'done_count': 0}
    
    def _get_claude_todos(self) -> List[Dict]:
        """Claude Code Todosï¼ˆãƒ¢ãƒƒã‚¯ - å®Ÿéš›ã¯å¤–éƒ¨ã‹ã‚‰å–å¾—ï¼‰"""
        # å®Ÿéš›ã®å®Ÿè£…ã§ã¯ TodoRead ã®çµæžœã‚’ä½¿ç”¨
        return [
            {'content': 'é‡è¤‡åˆ†æžå®Œäº†', 'status': 'completed', 'priority': 'high'},
            {'content': 'docså†ç·¨å®Œäº†', 'status': 'completed', 'priority': 'medium'}
        ]
    
    def _format_commitments(self, commitments: Dict) -> str:
        """ã‚³ãƒŸãƒƒãƒˆãƒ¡ãƒ³ãƒˆè¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ"""
        if not commitments['active']:
            return "âœ… No active commitments"
        
        lines = []
        for commit in commitments['active']:
            status_icon = "ðŸ”„" if commit.get('status') == 'pending' else "âš ï¸"
            lines.append(f"- {status_icon} {commit.get('description', 'Unknown')}")
        
        return "\n".join(lines)
    
    def _format_kanban(self, kanban: Dict) -> str:
        """Kanbanè¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ"""
        return f"""- ðŸ“‹ TODO: {kanban['todo_count']}
- ðŸ”„ IN PROGRESS: {kanban['in_progress_count']} / 2 (WIP limit)
- ðŸ‘ï¸ REVIEW: {kanban['review_count']}
- âœ… DONE: {kanban['done_count']}"""
    
    def _format_todos(self, todos: List[Dict]) -> str:
        """Todosè¡¨ç¤ºãƒ•ã‚©ãƒ¼ãƒžãƒƒãƒˆ"""
        if not todos:
            return "âœ… No todos"
        
        status_counts = {}
        for todo in todos:
            status = todo.get('status', 'unknown')
            status_counts[status] = status_counts.get(status, 0) + 1
        
        lines = []
        for status, count in status_counts.items():
            icon = {'pending': 'ðŸ“‹', 'in_progress': 'ðŸ”„', 'completed': 'âœ…'}.get(status, 'â“')
            lines.append(f"- {icon} {status.upper()}: {count}")
        
        return "\n".join(lines)
    
    def _check_alerts(self, commitments: Dict, kanban: Dict) -> str:
        """ã‚¢ãƒ©ãƒ¼ãƒˆãƒã‚§ãƒƒã‚¯"""
        alerts = []
        
        # WIPåˆ¶é™ãƒã‚§ãƒƒã‚¯
        if kanban['in_progress_count'] >= 2:
            alerts.append("âš ï¸ WIP limit reached (2/2 in progress)")
        
        # é•·æœŸpending commitments
        for commit in commitments['active']:
            if commit.get('status') == 'pending':
                # å®Ÿéš›ã¯æ™‚é–“ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè£…
                alerts.append(f"ðŸš¨ Pending commitment: {commit.get('description', 'Unknown')}")
        
        return "\n".join(alerts) if alerts else "âœ… No alerts"
    
    def update_status_files(self):
        """ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«æ›´æ–°"""
        # STATUS.mdç”Ÿæˆ
        status_content = self.generate_status_md()
        with open(self.status_file, 'w', encoding='utf-8') as f:
            f.write(status_content)
        
        print(f"âœ… Updated: {self.status_file}")
        
        # ç°¡æ˜“è¡¨ç¤ºã‚‚ç”Ÿæˆ
        self._generate_simple_display()
    
    def _generate_simple_display(self):
        """ã‚·ãƒ³ãƒ—ãƒ«è¡¨ç¤ºç”Ÿæˆ"""
        commitments = self._get_commitments()
        kanban = self._get_kanban_status()
        
        simple_status = f"""ðŸŽ¯ Tasks: {kanban['in_progress_count']}/2 active | âœ… {kanban['done_count']} done | ðŸ“‹ {commitments['total']} commitments"""
        
        # .task_status ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆä¸€è¡Œè¡¨ç¤ºç”¨ï¼‰
        with open(self.project_root / ".task_status", 'w') as f:
            f.write(simple_status)
    
    def show_brief_status(self):
        """ç°¡æ˜“ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º"""
        commitments = self._get_commitments()
        kanban = self._get_kanban_status()
        
        print("=" * 50)
        print("ðŸŽ¯ QUICK STATUS")
        print("=" * 50)
        print(f"ðŸ“‹ Active Tasks: {kanban['in_progress_count']}/2")
        print(f"âœ… Completed: {kanban['done_count']}")
        print(f"ðŸŽ¯ Commitments: {len(commitments['active'])}/{commitments['total']}")
        
        if kanban['in_progress_count'] > 0:
            print(f"ðŸ”„ Currently working on {kanban['in_progress_count']} tasks")
        
        print("=" * 50)
        print(f"ðŸ“„ Full status: cat STATUS.md")
        print("=" * 50)

def main():
    """ãƒ¡ã‚¤ãƒ³å®Ÿè¡Œ"""
    display = AutoStatusDisplay()
    
    import sys
    if "--brief" in sys.argv:
        display.show_brief_status()
    else:
        display.update_status_files()
        display.show_brief_status()

if __name__ == "__main__":
    main()