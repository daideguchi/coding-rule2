#!/bin/bash

# üîß „Ç®„É©„ÉºÊ§úÂá∫„ÉªËá™Âãï‰øÆÊ≠£„Ç∑„Çπ„ÉÜ„É† v2.0
# WORKER2„Å´„Çà„ÇäË®≠Ë®à„ÉªÂÆüË£Ö

set -euo pipefail

# „Ç∑„Çπ„ÉÜ„É†Ë®≠ÂÆö
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
LOG_DIR="${SCRIPT_DIR}/../logs"
ERROR_LOG="${LOG_DIR}/error-detection.log"
ERROR_DB="${SCRIPT_DIR}/error-database.json"
RECOVERY_SCRIPTS="${SCRIPT_DIR}/recovery-scripts"
LEARNING_DB="${SCRIPT_DIR}/error-learning.json"

# „É≠„Ç∞Èñ¢Êï∞
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${ERROR_LOG}"
}

alert() {
    echo "[ALERT][$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "${ERROR_LOG}"
    # „Ç¢„É©„Éº„ÉàÈÄöÁü•ÔºàÂÆüË£ÖÂèØËÉΩ„Å™Â†¥ÂêàÔºâ
}

# „Ç®„É©„Éº„Éë„Çø„Éº„É≥„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ
initialize_error_patterns() {
    cat > "${ERROR_DB}" << 'EOF'
{
  "detection_patterns": {
    "level_1_basic": {
      "syntax_error": {
        "patterns": ["SyntaxError", "ParseError", "IndentationError", "unexpected token"],
        "severity": "high",
        "auto_fix": true,
        "recovery_script": "fix_syntax_error.sh"
      },
      "file_not_found": {
        "patterns": ["No such file", "FileNotFoundError", "cannot access"],
        "severity": "medium",
        "auto_fix": true,
        "recovery_script": "fix_file_not_found.sh"
      },
      "permission_denied": {
        "patterns": ["Permission denied", "PermissionError", "Access forbidden"],
        "severity": "medium",
        "auto_fix": true,
        "recovery_script": "fix_permissions.sh"
      },
      "command_not_found": {
        "patterns": ["command not found", "not recognized", "No such command"],
        "severity": "medium",
        "auto_fix": true,
        "recovery_script": "fix_command_not_found.sh"
      }
    },
    "level_2_advanced": {
      "memory_error": {
        "patterns": ["MemoryError", "out of memory", "cannot allocate"],
        "severity": "high",
        "auto_fix": false,
        "recovery_script": "handle_memory_error.sh"
      },
      "network_error": {
        "patterns": ["Connection refused", "Network unreachable", "Timeout"],
        "severity": "medium",
        "auto_fix": true,
        "recovery_script": "fix_network_error.sh"
      },
      "dependency_error": {
        "patterns": ["ModuleNotFoundError", "ImportError", "No module named"],
        "severity": "high",
        "auto_fix": true,
        "recovery_script": "fix_dependencies.sh"
      }
    },
    "level_3_system": {
      "worker_hung": {
        "patterns": ["no response", "timeout", "unresponsive"],
        "severity": "critical",
        "auto_fix": true,
        "recovery_script": "recover_hung_worker.sh"
      },
      "session_lost": {
        "patterns": ["session not found", "connection lost", "session terminated"],
        "severity": "critical",
        "auto_fix": true,
        "recovery_script": "restore_session.sh"
      },
      "resource_conflict": {
        "patterns": ["resource busy", "lock timeout", "concurrent access"],
        "severity": "medium",
        "auto_fix": true,
        "recovery_script": "resolve_resource_conflict.sh"
      }
    }
  },
  "error_statistics": {
    "total_detected": 0,
    "auto_fixed": 0,
    "manual_intervention": 0,
    "detection_accuracy": 0
  }
}
EOF
    log "„Ç®„É©„Éº„Éë„Çø„Éº„É≥„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü"
}

# Â≠¶Áøí„Éá„Éº„Çø„Éô„Éº„ÇπÂàùÊúüÂåñ
initialize_learning_database() {
    cat > "${LEARNING_DB}" << 'EOF'
{
  "learned_patterns": [],
  "successful_fixes": [],
  "failed_fixes": [],
  "pattern_frequency": {},
  "fix_success_rate": {},
  "last_learning_update": null
}
EOF
    log "Â≠¶Áøí„Éá„Éº„Çø„Éô„Éº„Çπ„ÇíÂàùÊúüÂåñ„Åó„Åæ„Åó„Åü"
}

# ÂõûÂæ©„Çπ„ÇØ„É™„Éó„Éà„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
create_recovery_scripts() {
    mkdir -p "${RECOVERY_SCRIPTS}"
    
    # Âü∫Êú¨ÁöÑ„Å™ÂõûÂæ©„Çπ„ÇØ„É™„Éó„Éà‰ΩúÊàê
    
    # ÊßãÊñá„Ç®„É©„Éº‰øÆÊ≠£
    cat > "${RECOVERY_SCRIPTS}/fix_syntax_error.sh" << 'EOF'
#!/bin/bash
# ÊßãÊñá„Ç®„É©„ÉºËá™Âãï‰øÆÊ≠£„Çπ„ÇØ„É™„Éó„Éà
echo "ÊßãÊñá„Ç®„É©„Éº„ÅÆËá™Âãï‰øÆÊ≠£„ÇíË©¶Ë°å‰∏≠..."
# Âü∫Êú¨ÁöÑ„Å™ÊßãÊñá‰øÆÊ≠£„É≠„Ç∏„ÉÉ„ÇØ
exit 0
EOF
    
    # „Éï„Ç°„Ç§„É´‰∏çÂ≠òÂú®„Ç®„É©„Éº‰øÆÊ≠£
    cat > "${RECOVERY_SCRIPTS}/fix_file_not_found.sh" << 'EOF'
#!/bin/bash
# „Éï„Ç°„Ç§„É´‰∏çÂ≠òÂú®„Ç®„É©„Éº‰øÆÊ≠£„Çπ„ÇØ„É™„Éó„Éà
file_path="$1"
echo "„Éï„Ç°„Ç§„É´‰ΩúÊàê„ÇíË©¶Ë°å: ${file_path}"
# „Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê„Å®„Éï„Ç°„Ç§„É´‰ΩúÊàê
mkdir -p "$(dirname "${file_path}")"
touch "${file_path}"
exit 0
EOF
    
    # Ê®©Èôê„Ç®„É©„Éº‰øÆÊ≠£
    cat > "${RECOVERY_SCRIPTS}/fix_permissions.sh" << 'EOF'
#!/bin/bash
# Ê®©Èôê„Ç®„É©„Éº‰øÆÊ≠£„Çπ„ÇØ„É™„Éó„Éà
target="$1"
echo "Ê®©Èôê‰øÆÊ≠£„ÇíË©¶Ë°å: ${target}"
chmod +x "${target}" 2>/dev/null || true
exit 0
EOF
    
    # „ÉØ„Éº„Ç´„ÉºÂæ©Êóß
    cat > "${RECOVERY_SCRIPTS}/recover_hung_worker.sh" << 'EOF'
#!/bin/bash
# „ÉØ„Éº„Ç´„ÉºÂæ©Êóß„Çπ„ÇØ„É™„Éó„Éà
worker="$1"
session="multiagent:0.${worker: -1}"
echo "„ÉØ„Éº„Ç´„ÉºÂæ©Êóß„ÇíË©¶Ë°å: ${worker}"
tmux send-keys -t "${session}" C-c C-c
sleep 2
tmux send-keys -t "${session}" "clear" C-m
exit 0
EOF
    
    # „Åô„Åπ„Å¶„ÅÆ„Çπ„ÇØ„É™„Éó„Éà„Å´ÂÆüË°åÊ®©Èôê‰ªò‰∏é
    chmod +x "${RECOVERY_SCRIPTS}"/*.sh
    
    log "ÂõûÂæ©„Çπ„ÇØ„É™„Éó„Éà„Çí‰ΩúÊàê„Åó„Åæ„Åó„Åü"
}

# „Ç®„É©„ÉºÊ§úÂá∫„Ç®„É≥„Ç∏„É≥
detect_errors() {
    local source="$1"  # "worker" „Åæ„Åü„ÅØ "system"
    local target="${2:-all}"  # Ê§úÂá∫ÂØæË±°
    local detected_errors=()
    
    log "„Ç®„É©„ÉºÊ§úÂá∫ÈñãÂßã: ${source} ‚Üí ${target}"
    
    case "${source}" in
        "worker")
            detected_errors=($(detect_worker_errors "${target}"))
            ;;
        "system")
            detected_errors=($(detect_system_errors))
            ;;
        "logs")
            detected_errors=($(detect_log_errors "${target}"))
            ;;
        *)
            log "ERROR: ‰∏çÊòé„Å™Ê§úÂá∫„ÇΩ„Éº„Çπ: ${source}"
            return 1
            ;;
    esac
    
    # Ê§úÂá∫ÁµêÊûúÂá¶ÁêÜ
    if [ ${#detected_errors[@]} -gt 0 ]; then
        log "„Ç®„É©„ÉºÊ§úÂá∫: ${#detected_errors[@]}‰ª∂"
        for error in "${detected_errors[@]}"; do
            process_detected_error "${error}"
        done
    else
        log "„Ç®„É©„ÉºÊ§úÂá∫: „Å™„Åó"
    fi
    
    return 0
}

# „ÉØ„Éº„Ç´„Éº„Ç®„É©„ÉºÊ§úÂá∫
detect_worker_errors() {
    local worker="${1:-all}"
    local errors=()
    
    if [ "${worker}" = "all" ]; then
        for w in 1 2 3; do
            local worker_errors=($(detect_single_worker_errors "WORKER${w}"))
            errors+=("${worker_errors[@]}")
        done
        # BOSS1„Å®PRESIDENT„ÇÇÁ¢∫Ë™ç
        local boss_errors=($(detect_single_worker_errors "BOSS1"))
        errors+=("${boss_errors[@]}")
    else
        errors=($(detect_single_worker_errors "${worker}"))
    fi
    
    printf '%s\n' "${errors[@]}"
}

# Âçò‰∏Ä„ÉØ„Éº„Ç´„Éº„Ç®„É©„ÉºÊ§úÂá∫
detect_single_worker_errors() {
    local worker="$1"
    local session_name=""
    local errors=()
    
    # „Çª„ÉÉ„Ç∑„Éß„É≥ÂêçÊ±∫ÂÆö
    case "${worker}" in
        "BOSS1") session_name="multiagent:0.0" ;;
        "WORKER1") session_name="multiagent:0.1" ;;
        "WORKER2") session_name="multiagent:0.2" ;;
        "WORKER3") session_name="multiagent:0.3" ;;
        *) return 1 ;;
    esac
    
    # „Çª„ÉÉ„Ç∑„Éß„É≥Â≠òÂú®Á¢∫Ë™ç
    if ! tmux has-session -t "${session_name}" 2>/dev/null; then
        errors+=("${worker}:session_lost:critical")
        printf '%s\n' "${errors[@]}"
        return 0
    fi
    
    # ÁîªÈù¢Âá∫ÂäõÂèñÂæó
    local output=$(tmux capture-pane -t "${session_name}" -p 2>/dev/null || echo "")
    local recent_output=$(echo "${output}" | tail -20)
    
    # „Ç®„É©„Éº„Éë„Çø„Éº„É≥„Éû„ÉÉ„ÉÅ„É≥„Ç∞
    if [ -f "${ERROR_DB}" ]; then
        # Level 1 „Ç®„É©„ÉºÊ§úÂá∫
        while IFS= read -r pattern; do
            if echo "${recent_output}" | grep -qi "${pattern}"; then
                local error_type=$(get_error_type "${pattern}")
                errors+=("${worker}:${error_type}:high")
                log "Level 1 „Ç®„É©„ÉºÊ§úÂá∫: ${worker} ‚Üí ${error_type}"
            fi
        done < <(cat "${ERROR_DB}" | jq -r '.detection_patterns.level_1_basic[].patterns[]')
        
        # Level 2 „Ç®„É©„ÉºÊ§úÂá∫
        while IFS= read -r pattern; do
            if echo "${recent_output}" | grep -qi "${pattern}"; then
                local error_type=$(get_error_type "${pattern}")
                errors+=("${worker}:${error_type}:medium")
                log "Level 2 „Ç®„É©„ÉºÊ§úÂá∫: ${worker} ‚Üí ${error_type}"
            fi
        done < <(cat "${ERROR_DB}" | jq -r '.detection_patterns.level_2_advanced[].patterns[]')
    fi
    
    # ÁÑ°ÂøúÁ≠îÊ§úÂá∫
    if echo "${recent_output}" | tail -5 | grep -q ">" && \
       [ "$(echo "${recent_output}" | wc -l)" -lt 5 ]; then
        # ÊúÄËøë„ÅÆÊ¥ªÂãï„ÅåÂ∞ë„Å™„ÅÑ = ÁÑ°ÂøúÁ≠î„ÅÆÂèØËÉΩÊÄß
        errors+=("${worker}:no_response:medium")
        log "ÁÑ°ÂøúÁ≠îÊ§úÂá∫: ${worker}"
    fi
    
    printf '%s\n' "${errors[@]}"
}

# „Ç∑„Çπ„ÉÜ„É†„Ç®„É©„ÉºÊ§úÂá∫
detect_system_errors() {
    local errors=()
    
    # „Éá„Ç£„Çπ„ÇØÂÆπÈáè„ÉÅ„Çß„ÉÉ„ÇØ
    local disk_usage=$(df . | awk 'NR==2 {print $5}' | sed 's/%//')
    if [ "${disk_usage}" -gt 90 ]; then
        errors+=("system:disk_full:critical")
        log "„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„ÉºÊ§úÂá∫: „Éá„Ç£„Çπ„ÇØÂÆπÈáè‰∏çË∂≥ (${disk_usage}%)"
    fi
    
    # „É°„É¢„É™‰ΩøÁî®Èáè„ÉÅ„Çß„ÉÉ„ÇØ
    local mem_usage=$(free | awk 'NR==2{printf "%.0f", $3*100/$2}')
    if [ "${mem_usage}" -gt 90 ]; then
        errors+=("system:memory_high:high")
        log "„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„ÉºÊ§úÂá∫: „É°„É¢„É™‰ΩøÁî®ÈáèÈ´ò (${mem_usage}%)"
    fi
    
    # „Éó„É≠„Çª„ÇπÁ¢∫Ë™ç
    if ! pgrep -f "tmux" > /dev/null; then
        errors+=("system:tmux_not_running:critical")
        log "„Ç∑„Çπ„ÉÜ„É†„Ç®„É©„ÉºÊ§úÂá∫: tmuxÊú™ÂÆüË°å"
    fi
    
    printf '%s\n' "${errors[@]}"
}

# „É≠„Ç∞„Ç®„É©„ÉºÊ§úÂá∫
detect_log_errors() {
    local log_file="${1:-${ERROR_LOG}}"
    local errors=()
    
    if [ -f "${log_file}" ]; then
        # ÊúÄËøë„ÅÆ„Ç®„É©„Éº„É≠„Ç∞Á¢∫Ë™ç
        local recent_errors=$(tail -100 "${log_file}" | grep -i "error\|failed\|exception" | wc -l)
        if [ "${recent_errors}" -gt 5 ]; then
            errors+=("logs:error_spike:medium")
            log "„É≠„Ç∞„Ç®„É©„ÉºÊ§úÂá∫: „Ç®„É©„ÉºÊÄ•Â¢ó (${recent_errors}‰ª∂)"
        fi
    fi
    
    printf '%s\n' "${errors[@]}"
}

# „Ç®„É©„Éº„Çø„Ç§„ÉóÁâπÂÆö
get_error_type() {
    local pattern="$1"
    local error_type="unknown"
    
    if [ -f "${ERROR_DB}" ]; then
        error_type=$(cat "${ERROR_DB}" | jq -r "
            .detection_patterns[][] | 
            select(.patterns[] | test(\"${pattern}\"; \"i\")) | 
            keys[0]
        " 2>/dev/null | head -1)
    fi
    
    echo "${error_type:-unknown}"
}

# Ê§úÂá∫„Ç®„É©„ÉºÂá¶ÁêÜ
process_detected_error() {
    local error_info="$1"
    IFS=':' read -r component error_type severity <<< "${error_info}"
    
    log "„Ç®„É©„ÉºÂá¶ÁêÜÈñãÂßã: ${component} ‚Üí ${error_type} (${severity})"
    
    # „Ç®„É©„ÉºÁµ±Ë®àÊõ¥Êñ∞
    update_error_statistics "${error_type}" "detected"
    
    # Ëá™Âãï‰øÆÊ≠£Âà§ÂÆö
    local auto_fix=$(should_auto_fix "${error_type}")
    
    if [ "${auto_fix}" = "true" ]; then
        attempt_auto_fix "${component}" "${error_type}" "${severity}"
    else
        log "ÊâãÂãï‰ªãÂÖ•„ÅåÂøÖË¶Å: ${component} ‚Üí ${error_type}"
        alert "ÊâãÂãï‰ªãÂÖ•Ë¶ÅÊ±Ç: ${component} „Åß„Ç®„É©„Éº ${error_type} „ÅåÊ§úÂá∫„Åï„Çå„Åæ„Åó„Åü"
        update_error_statistics "${error_type}" "manual_intervention"
    fi
}

# Ëá™Âãï‰øÆÊ≠£Âà§ÂÆö
should_auto_fix() {
    local error_type="$1"
    local auto_fix="false"
    
    if [ -f "${ERROR_DB}" ]; then
        auto_fix=$(cat "${ERROR_DB}" | jq -r "
            .detection_patterns[][] | 
            select(keys[0] == \"${error_type}\") | 
            .auto_fix
        " 2>/dev/null | head -1)
    fi
    
    # Â≠¶Áøí„Éá„Éº„Çø„Éô„Éº„Çπ„Åã„ÇâÊàêÂäüÁéáÁ¢∫Ë™ç
    if [ -f "${LEARNING_DB}" ]; then
        local success_rate=$(cat "${LEARNING_DB}" | jq -r ".fix_success_rate.${error_type} // 0")
        if (( $(echo "${success_rate} < 0.3" | bc -l) )); then
            auto_fix="false"  # ÊàêÂäüÁéá„Åå‰Ωé„ÅÑÂ†¥Âêà„ÅØËá™Âãï‰øÆÊ≠£„Åó„Å™„ÅÑ
        fi
    fi
    
    echo "${auto_fix:-false}"
}

# Ëá™Âãï‰øÆÊ≠£Ë©¶Ë°å
attempt_auto_fix() {
    local component="$1"
    local error_type="$2"
    local severity="$3"
    
    log "Ëá™Âãï‰øÆÊ≠£Ë©¶Ë°å: ${component} ‚Üí ${error_type}"
    
    # ÂõûÂæ©„Çπ„ÇØ„É™„Éó„ÉàÁâπÂÆö
    local recovery_script
    if [ -f "${ERROR_DB}" ]; then
        recovery_script=$(cat "${ERROR_DB}" | jq -r "
            .detection_patterns[][] | 
            select(keys[0] == \"${error_type}\") | 
            .recovery_script
        " 2>/dev/null | head -1)
    fi
    
    if [ -n "${recovery_script}" ] && [ -f "${RECOVERY_SCRIPTS}/${recovery_script}" ]; then
        log "ÂõûÂæ©„Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å: ${recovery_script}"
        
        # ‰øÆÊ≠£ÂâçÁä∂ÊÖãË®òÈå≤
        local pre_fix_state=$(capture_component_state "${component}")
        
        # ‰øÆÊ≠£ÂÆüË°å
        local fix_start_time=$(date +%s)
        if "${RECOVERY_SCRIPTS}/${recovery_script}" "${component}"; then
            local fix_end_time=$(date +%s)
            local fix_duration=$((fix_end_time - fix_start_time))
            
            # ‰øÆÊ≠£ÂæåÊ§úË®º
            sleep 5  # ‰øÆÊ≠£ÂäπÊûúÁ¢∫Ë™ç„ÅÆ„Åü„ÇÅ„ÅÆÂæÖÊ©ü
            local post_fix_state=$(capture_component_state "${component}")
            
            if verify_fix_success "${component}" "${error_type}" "${pre_fix_state}" "${post_fix_state}"; then
                log "Ëá™Âãï‰øÆÊ≠£ÊàêÂäü: ${component} ‚Üí ${error_type} (${fix_duration}Áßí)"
                update_error_statistics "${error_type}" "auto_fixed"
                record_successful_fix "${component}" "${error_type}" "${recovery_script}" "${fix_duration}"
            else
                log "Ëá™Âãï‰øÆÊ≠£Â§±Êïó: ÂäπÊûúÁ¢∫Ë™ç‰∏çÂèØ ${component} ‚Üí ${error_type}"
                update_error_statistics "${error_type}" "fix_failed"
                record_failed_fix "${component}" "${error_type}" "${recovery_script}"
            fi
        else
            log "Ëá™Âãï‰øÆÊ≠£Â§±Êïó: „Çπ„ÇØ„É™„Éó„ÉàÂÆüË°å„Ç®„É©„Éº ${component} ‚Üí ${error_type}"
            update_error_statistics "${error_type}" "fix_failed"
            record_failed_fix "${component}" "${error_type}" "${recovery_script}"
        fi
    else
        log "ÂõûÂæ©„Çπ„ÇØ„É™„Éó„Éà‰∏çÂ≠òÂú®: ${recovery_script}"
        alert "ÂõûÂæ©„Çπ„ÇØ„É™„Éó„Éà„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì: ${error_type}"
    fi
}

# „Ç≥„É≥„Éù„Éº„Éç„É≥„ÉàÁä∂ÊÖã„Ç≠„É£„Éó„ÉÅ„É£
capture_component_state() {
    local component="$1"
    local state="{}"
    
    case "${component}" in
        WORKER*|BOSS1)
            local session_name=""
            case "${component}" in
                "BOSS1") session_name="multiagent:0.0" ;;
                "WORKER1") session_name="multiagent:0.1" ;;
                "WORKER2") session_name="multiagent:0.2" ;;
                "WORKER3") session_name="multiagent:0.3" ;;
            esac
            
            if tmux has-session -t "${session_name}" 2>/dev/null; then
                local output=$(tmux capture-pane -t "${session_name}" -p 2>/dev/null || echo "")
                state=$(cat << EOF
{
  "session_active": true,
  "last_output": $(echo "${output}" | tail -5 | jq -R -s .),
  "timestamp": "$(date -Iseconds)"
}
EOF
)
            else
                state='{"session_active": false, "timestamp": "'$(date -Iseconds)'"}'
            fi
            ;;
        system)
            state=$(cat << EOF
{
  "disk_usage": $(df . | awk 'NR==2 {print $5}' | sed 's/%//'),
  "memory_usage": $(free | awk 'NR==2{printf "%.0f", $3*100/$2}'),
  "tmux_running": $(pgrep -f "tmux" > /dev/null && echo true || echo false),
  "timestamp": "$(date -Iseconds)"
}
EOF
)
            ;;
    esac
    
    echo "${state}"
}

# ‰øÆÊ≠£ÊàêÂäüÊ§úË®º
verify_fix_success() {
    local component="$1"
    local error_type="$2"
    local pre_state="$3"
    local post_state="$4"
    
    # Âü∫Êú¨ÁöÑ„Å™Ê§úË®º„É≠„Ç∏„ÉÉ„ÇØ
    case "${error_type}" in
        "session_lost")
            local post_active=$(echo "${post_state}" | jq -r '.session_active')
            [ "${post_active}" = "true" ]
            ;;
        "no_response")
            local post_output=$(echo "${post_state}" | jq -r '.last_output')
            echo "${post_output}" | grep -q ">"
            ;;
        *)
            # „Éá„Éï„Ç©„É´„Éà: „Ç®„É©„ÉºÂÜçÊ§úÂá∫„Åå„Å™„ÅÑ„Åì„Å®„ÇíÁ¢∫Ë™ç
            local redetected_errors=($(detect_single_worker_errors "${component}"))
            [ ${#redetected_errors[@]} -eq 0 ]
            ;;
    esac
}

# „Ç®„É©„ÉºÁµ±Ë®àÊõ¥Êñ∞
update_error_statistics() {
    local error_type="$1"
    local action="$2"  # detected, auto_fixed, manual_intervention, fix_failed
    
    if [ ! -f "${ERROR_DB}" ]; then
        initialize_error_patterns
    fi
    
    local temp_file=$(mktemp)
    cat "${ERROR_DB}" | jq "
        .error_statistics.total_detected += (if \"${action}\" == \"detected\" then 1 else 0 end) |
        .error_statistics.auto_fixed += (if \"${action}\" == \"auto_fixed\" then 1 else 0 end) |
        .error_statistics.manual_intervention += (if \"${action}\" == \"manual_intervention\" then 1 else 0 end)
    " > "${temp_file}"
    
    mv "${temp_file}" "${ERROR_DB}"
}

# ÊàêÂäü‰øÆÊ≠£Ë®òÈå≤
record_successful_fix() {
    local component="$1"
    local error_type="$2"
    local recovery_script="$3"
    local duration="$4"
    
    if [ ! -f "${LEARNING_DB}" ]; then
        initialize_learning_database
    fi
    
    local fix_record=$(cat << EOF
{
  "component": "${component}",
  "error_type": "${error_type}",
  "recovery_script": "${recovery_script}",
  "duration": ${duration},
  "timestamp": "$(date -Iseconds)"
}
EOF
)
    
    local temp_file=$(mktemp)
    cat "${LEARNING_DB}" | jq ".successful_fixes += [${fix_record}]" > "${temp_file}"
    mv "${temp_file}" "${LEARNING_DB}"
    
    update_fix_success_rate "${error_type}" true
}

# Â§±Êïó‰øÆÊ≠£Ë®òÈå≤
record_failed_fix() {
    local component="$1"
    local error_type="$2"
    local recovery_script="$3"
    
    if [ ! -f "${LEARNING_DB}" ]; then
        initialize_learning_database
    fi
    
    local fail_record=$(cat << EOF
{
  "component": "${component}",
  "error_type": "${error_type}",
  "recovery_script": "${recovery_script}",
  "timestamp": "$(date -Iseconds)"
}
EOF
)
    
    local temp_file=$(mktemp)
    cat "${LEARNING_DB}" | jq ".failed_fixes += [${fail_record}]" > "${temp_file}"
    mv "${temp_file}" "${LEARNING_DB}"
    
    update_fix_success_rate "${error_type}" false
}

# ‰øÆÊ≠£ÊàêÂäüÁéáÊõ¥Êñ∞
update_fix_success_rate() {
    local error_type="$1"
    local success="$2"  # true/false
    
    if [ ! -f "${LEARNING_DB}" ]; then
        return 1
    fi
    
    local temp_file=$(mktemp)
    cat "${LEARNING_DB}" | jq "
        .fix_success_rate.${error_type} = (
            (.successful_fixes | map(select(.error_type == \"${error_type}\")) | length) /
            ((.successful_fixes | map(select(.error_type == \"${error_type}\")) | length) +
             (.failed_fixes | map(select(.error_type == \"${error_type}\")) | length))
        )
    " > "${temp_file}"
    
    mv "${temp_file}" "${LEARNING_DB}"
}

# Á∂ôÁ∂öÁõ£Ë¶ñÈñãÂßã
start_continuous_monitoring() {
    local interval_seconds="${1:-60}"
    
    log "Á∂ôÁ∂öÁõ£Ë¶ñÈñãÂßãÔºàÈñìÈöî: ${interval_seconds}ÁßíÔºâ"
    
    while true; do
        # ÂÖ®„Ç®„É©„ÉºÊ§úÂá∫ÂÆüË°å
        detect_errors "worker" "all"
        detect_errors "system"
        
        # Â≠¶Áøí„Éá„Éº„ÇøÊõ¥Êñ∞
        update_learning_patterns
        
        sleep "${interval_seconds}"
    done
}

# Â≠¶Áøí„Éë„Çø„Éº„É≥Êõ¥Êñ∞
update_learning_patterns() {
    if [ ! -f "${LEARNING_DB}" ]; then
        return 1
    fi
    
    # Êñ∞„Åó„ÅÑ„Ç®„É©„Éº„Éë„Çø„Éº„É≥„ÅÆÂ≠¶Áøí„É≠„Ç∏„ÉÉ„ÇØ
    # (ÂÆüË£ÖÁ∞°Áï•Âåñ„ÅÆ„Åü„ÇÅÂü∫Êú¨ÊßãÈÄ†„ÅÆ„Åø)
    
    local temp_file=$(mktemp)
    cat "${LEARNING_DB}" | jq ".last_learning_update = \"$(date -Iseconds)\"" > "${temp_file}"
    mv "${temp_file}" "${LEARNING_DB}"
}

# „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê
generate_error_report() {
    local report_file="${LOG_DIR}/error-detection-report-$(date +%Y%m%d-%H%M%S).md"
    
    cat > "${report_file}" << EOF
# „Ç®„É©„ÉºÊ§úÂá∫„ÉªËá™Âãï‰øÆÊ≠£„Ç∑„Çπ„ÉÜ„É† „É¨„Éù„Éº„Éà

## ÁîüÊàêÊó•ÊôÇ: $(date '+%Y-%m-%d %H:%M:%S')

## „Ç®„É©„ÉºÁµ±Ë®à
EOF
    
    if [ -f "${ERROR_DB}" ]; then
        echo "### Ê§úÂá∫„Éª‰øÆÊ≠£Áµ±Ë®à" >> "${report_file}"
        cat "${ERROR_DB}" | jq -r '
            .error_statistics |
            "- Á∑èÊ§úÂá∫Êï∞: " + (.total_detected | tostring),
            "- Ëá™Âãï‰øÆÊ≠£ÊàêÂäü: " + (.auto_fixed | tostring),
            "- ÊâãÂãï‰ªãÂÖ•Ë¶ÅÊ±Ç: " + (.manual_intervention | tostring)
        ' >> "${report_file}"
    fi
    
    if [ -f "${LEARNING_DB}" ]; then
        echo "" >> "${report_file}"
        echo "### Â≠¶Áøí„Éá„Éº„Çø" >> "${report_file}"
        cat "${LEARNING_DB}" | jq -r '
            "- ÊàêÂäü‰øÆÊ≠£Êï∞: " + (.successful_fixes | length | tostring),
            "- Â§±Êïó‰øÆÊ≠£Êï∞: " + (.failed_fixes | length | tostring),
            "- ÊúÄÁµÇÂ≠¶ÁøíÊõ¥Êñ∞: " + (.last_learning_update // "Êú™ÂÆüË°å")
        ' >> "${report_file}"
    fi
    
    cat >> "${report_file}" << EOF

## ÊúÄÊñ∞Ê§úÂá∫„É≠„Ç∞ (Áõ¥Ëøë30‰ª∂)
$(tail -30 "${ERROR_LOG}" 2>/dev/null || echo "„É≠„Ç∞„Å™„Åó")

---
*Ëá™ÂãïÁîüÊàê: „Ç®„É©„ÉºÊ§úÂá∫„ÉªËá™Âãï‰øÆÊ≠£„Ç∑„Çπ„ÉÜ„É†*
EOF
    
    log "„Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê: ${report_file}"
    echo "${report_file}"
}

# „É°„Ç§„É≥Âá¶ÁêÜ
main() {
    local command=${1:-"help"}
    
    case "${command}" in
        "init")
            initialize_error_patterns
            initialize_learning_database
            create_recovery_scripts
            ;;
        "detect")
            local source="${2:-worker}"
            local target="${3:-all}"
            detect_errors "${source}" "${target}"
            ;;
        "monitor")
            local interval="${2:-60}"
            start_continuous_monitoring "${interval}"
            ;;
        "fix")
            local component="${2:-""}"
            local error_type="${3:-""}"
            if [ -n "${component}" ] && [ -n "${error_type}" ]; then
                attempt_auto_fix "${component}" "${error_type}" "manual"
            else
                echo "„Ç®„É©„Éº: „Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Å®„Ç®„É©„Éº„Çø„Ç§„Éó„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ"
                exit 1
            fi
            ;;
        "status")
            if [ -f "${ERROR_DB}" ]; then
                echo "üìä „Ç®„É©„ÉºÊ§úÂá∫„Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥Å"
                echo "========================="
                cat "${ERROR_DB}" | jq '.error_statistics'
            else
                echo "„Éá„Éº„Çø„Éô„Éº„ÇπÊú™ÂàùÊúüÂåñ"
            fi
            ;;
        "report")
            generate_error_report
            ;;
        "help")
            cat << EOF
üîß „Ç®„É©„ÉºÊ§úÂá∫„ÉªËá™Âãï‰øÆÊ≠£„Ç∑„Çπ„ÉÜ„É† v2.0

‰ΩøÁî®ÊñπÊ≥ï:
  $0 init                           # „Ç∑„Çπ„ÉÜ„É†ÂàùÊúüÂåñ
  $0 detect <source> [target]       # „Ç®„É©„ÉºÊ§úÂá∫ÂÆüË°å
  $0 monitor [interval]             # Á∂ôÁ∂öÁõ£Ë¶ñÈñãÂßã
  $0 fix <component> <error_type>   # ÊâãÂãï‰øÆÊ≠£ÂÆüË°å
  $0 status                         # „Ç∑„Çπ„ÉÜ„É†Áä∂Ê≥ÅË°®Á§∫
  $0 report                         # „Ç®„É©„Éº„É¨„Éù„Éº„ÉàÁîüÊàê

Ê§úÂá∫„ÇΩ„Éº„Çπ: worker, system, logs
ÂØæË±°: all, WORKER1, WORKER2, WORKER3, BOSS1

Ê©üËÉΩ:
- Â§öÊÆµÈöé„Ç®„É©„ÉºÊ§úÂá∫
- Ëá™Âãï‰øÆÊ≠£„ÉªÂæ©Êóß
- Â≠¶ÁøíÊ©üËÉΩ„Å´„Çà„ÇãÊîπÂñÑ
- Á∂ôÁ∂öÁõ£Ë¶ñ„Éª„Ç¢„É©„Éº„Éà
EOF
            ;;
        *)
            echo "„Ç®„É©„Éº: ‰∏çÊòé„Å™„Ç≥„Éû„É≥„Éâ '${command}'"
            echo "‰ΩøÁî®ÊñπÊ≥ï: $0 help"
            exit 1
            ;;
    esac
}

# „É≠„Ç∞„Éá„Ç£„É¨„ÇØ„Éà„É™‰ΩúÊàê
mkdir -p "${LOG_DIR}"

# „É°„Ç§„É≥ÂÆüË°å
main "$@"