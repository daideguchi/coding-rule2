#!/bin/bash
# Âé≥Ê†º„Éï„Ç°„Ç§„É´‰ΩúÊàêÊ§úË®º„Éï„ÉÉ„ÇØ
# Êñ∞Ë¶è„Éï„Ç°„Ç§„É´‰ΩúÊàêÂâç„Å´Ëá™ÂãïÂÆüË°å„Åï„Çå„ÇãÊ§úË®º

set -e

# „Ç´„É©„ÉºÂÆöÁæ©
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# „Éó„É≠„Ç∏„Çß„ÇØ„Éà„É´„Éº„ÉàÊ§úÂá∫
PROJECT_ROOT=$(git rev-parse --show-toplevel 2>/dev/null || pwd)

# Ê§úË®º„Çπ„ÇØ„É™„Éó„Éà„Éë„Çπ
VALIDATOR="$PROJECT_ROOT/scripts/validate-file-creation.py"

# Ê§úË®º„Çπ„ÇØ„É™„Éó„Éà„ÅÆÂ≠òÂú®Á¢∫Ë™ç
if [ ! -f "$VALIDATOR" ]; then
    echo -e "${RED}‚ùå Error: Validation script not found${NC}"
    echo "Expected at: $VALIDATOR"
    exit 1
fi

# ‰ΩúÊàêÂØæË±°„ÅÆÊ§úÂá∫
if [ -n "$1" ]; then
    TARGET="$1"
else
    # git status „Åã„ÇâÊñ∞Ë¶è„Éï„Ç°„Ç§„É´„ÇíÊ§úÂá∫
    TARGET=$(git status --porcelain | grep '^??' | awk '{print $2}' | head -1)
fi

if [ -z "$TARGET" ]; then
    echo -e "${YELLOW}‚ö†Ô∏è  No new files detected${NC}"
    exit 0
fi

echo -e "${GREEN}üîç Validating new file creation...${NC}"
echo "Target: $TARGET"

# „Éá„Ç£„É¨„ÇØ„Éà„É™„Åã„Éï„Ç°„Ç§„É´„Åã„ÇíÂà§ÂÆö
IS_DIR=""
if [ -d "$TARGET" ]; then
    IS_DIR="--directory"
fi

# Ê§úË®ºÂÆüË°å
if python3 "$VALIDATOR" "$TARGET" $IS_DIR; then
    echo -e "${GREEN}‚úÖ Validation passed${NC}"
    
    # „É°„Çø„Éá„Éº„ÇøÁîüÊàê„ÅÆÊèêÊ°à
    echo -e "${YELLOW}üí° Don't forget to add metadata:${NC}"
    echo "   - Owner/team information"
    echo "   - Purpose documentation"
    echo "   - Access controls (if needed)"
else
    echo -e "${RED}‚ùå Validation failed${NC}"
    echo ""
    echo "Options:"
    echo "1. Fix the issues manually"
    echo "2. Run with auto-fix: python3 $VALIDATOR \"$TARGET\" --fix"
    echo "3. Check the rules: cat $PROJECT_ROOT/docs/rules/strict-file-creation-rules.md"
    
    # Ëá™Âãï‰øÆÊ≠£„ÅÆÊèêÊ°à
    echo ""
    echo -e "${YELLOW}üîß Attempting auto-fix suggestion...${NC}"
    python3 "$VALIDATOR" "$TARGET" $IS_DIR --fix
    
    exit 1
fi

# „Çª„Ç≠„É•„É™„ÉÜ„Ç£„ÉÅ„Çß„ÉÉ„ÇØÔºà„Ç™„Éó„Ç∑„Éß„É≥Ôºâ
if command -v gitleaks &> /dev/null; then
    echo -e "${GREEN}üîí Running security scan...${NC}"
    if ! gitleaks detect --no-git --source="$TARGET" 2>/dev/null; then
        echo -e "${RED}‚ö†Ô∏è  Security warning: Potential secrets detected${NC}"
        exit 1
    fi
fi

exit 0